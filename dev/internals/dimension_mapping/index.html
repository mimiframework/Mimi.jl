<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Cross-model Connectors · Mimi.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Mimi.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../tutorials/tutorial_main/">Tutorials Intro</a></li><li><a class="tocitem" href="../../tutorials/tutorial_1/">1 Install Mimi</a></li><li><a class="tocitem" href="../../tutorials/tutorial_2/">2 Run an Existing Model</a></li><li><a class="tocitem" href="../../tutorials/tutorial_3/">3 Modify an Existing Model</a></li><li><a class="tocitem" href="../../tutorials/tutorial_4/">4 Create a Model</a></li><li><a class="tocitem" href="../../tutorials/tutorial_5/">5 Monte Carlo + Sensitivity Analysis</a></li><li><a class="tocitem" href="../../tutorials/tutorial_6/">6 Create a Model with Composite Components</a></li></ul></li><li><span class="tocitem">How-to Guides</span><ul><li><a class="tocitem" href="../../howto/howto_main/">How-to Guides Intro</a></li><li><a class="tocitem" href="../../howto/howto_1/">1 Construct + Run a Model</a></li><li><a class="tocitem" href="../../howto/howto_2/">2 Explore Results</a></li><li><a class="tocitem" href="../../howto/howto_3/">3 Monte Carlo + SA</a></li><li><a class="tocitem" href="../../howto/howto_4/">4 Timesteps</a></li><li><a class="tocitem" href="../../howto/howto_5/">5 Parameters + Variables</a></li><li><a class="tocitem" href="../../howto/howto_6/">6 Update Time Dimension</a></li><li><a class="tocitem" href="../../howto/howto_7/">7 Port to v0.5.0</a></li><li><a class="tocitem" href="../../howto/howto_8/">8 Port to v1.0.0</a></li><li><a class="tocitem" href="../../howto/howto_9/">9 Port to New Param API</a></li></ul></li><li><span class="tocitem">Advanced How-to Guides</span><ul><li><a class="tocitem" href="../../howto_advanced/howto_adv_main/">Advanced How-to Guides Intro</a></li><li><a class="tocitem" href="../../howto_advanced/howto_adv_buildinit/">Build and Init Functions</a></li><li><a class="tocitem" href="../../howto_advanced/howto_adv_datumrefs/">Using Datum References</a></li></ul></li><li><span class="tocitem">Reference Guides</span><ul><li><a class="tocitem" href="../../ref/ref_main/">Reference Guides Intro</a></li><li><a class="tocitem" href="../../ref/ref_API/">Mimi API</a></li><li><a class="tocitem" href="../../ref/ref_structures_classes_types/">Structures: Classes.jl and Types</a></li><li><a class="tocitem" href="../../ref/ref_structures_definitions/">Structures: Definitions</a></li><li><a class="tocitem" href="../../ref/ref_structures_instances/">Structures: Instances</a></li></ul></li><li><span class="tocitem">Explanations</span><ul><li><a class="tocitem" href="../../explanations/exp_main/">Explanations Intro</a></li><li><a class="tocitem" href="../../explanations/exp_pkgs/">Models as Packages</a></li></ul></li><li><a class="tocitem" href="../../faq/">FAQ</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Cross-model Connectors</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Cross-model Connectors</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/mimiframework/Mimi.jl/blob/master/docs/src/internals/dimension_mapping.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Cross-model-Connectors-1"><a class="docs-heading-anchor" href="#Cross-model-Connectors-1">Cross-model Connectors</a><a class="docs-heading-anchor-permalink" href="#Cross-model-Connectors-1" title="Permalink"></a></h1><h2 id="Thoughts-on-matching-indices-across-models-that-may-have-different-timesteps,-regional-aggregations,-etc.-1"><a class="docs-heading-anchor" href="#Thoughts-on-matching-indices-across-models-that-may-have-different-timesteps,-regional-aggregations,-etc.-1">Thoughts on matching indices across models that may have different timesteps, regional aggregations, etc.</a><a class="docs-heading-anchor-permalink" href="#Thoughts-on-matching-indices-across-models-that-may-have-different-timesteps,-regional-aggregations,-etc.-1" title="Permalink"></a></h2><p>The basic idea is to allow a keyword arg to connect_param!() to identify a connector  component that performs the mapping between disparate dimension definitions.</p><p>We could provide a couple more &quot;standard&quot; connectors</p><ul><li>Time<ul><li>Get most recent value from before the receiving model&#39;s current timestep</li><li>Get the sum of values between the receiving model&#39;s current and prior timestep</li></ul></li><li>Regions<ul><li>Pass in a region map that defines transformations between two regional definitions</li><li>Operators can include<ul><li>Weighted Avg:  new region value = avg(parameter[regions] .* weight[regions])</li><li>Weighted sum: new region value = sum(parameter[regions] .* weight[regions])</li></ul></li><li>Weights can be the value of some parameter, e.g., population, area, GDP</li><li>Disaggregation can be handled similarly<ul><li>new sub-region value = parameter[region] * weight[region]</li></ul></li></ul></li></ul><p>We can create macro to define connector components that perform these dimension adjustments. We would define a new macro that simplifies creation of a <code>@defcomp</code> of a given name  that can be specified in connect_param! to perform the defined mapping.</p><p>To map across both time and regions, we could implement a pair of connector components that might look like the following, which would be called for each timestep <code>t</code> in  the receiving component:</p><pre><code class="language-julia"># This component would run first, mapping emissions to the new time boundaries
@defcomp time_mapper begin
    src = Variable(index=[m1.time, m1.regions])
    dst = Parameter(index=[m2.time, m1.regions])   # uses src model&#39;s regions

    # Simple time adapter that just sums any values produced since the prior 
    # timestep, without performing any allocation or interpolation.
    function run_timestep(p, v, d, t)
        for r in d.regions
            values = [v.src[tsrc, r] for tsrc in m1.time if t - 1 &lt; tsrc &lt;= t]
            p.dst[t, r] = sum(values)
        end
    end
end

# This component would run next, mapping emissions to the new regional boundaries
@defcomp region_mapper begin
    # Source here would be the emissions_time_mapper component
    src  = Variable(index=[time, m1.regions])
    sgdp = Variable(index=[time, m1.regions])
    dst  = Parameter(index=[time, m2.regions])
    dgdp = Parameter(index=[time, m2.regions])

    function run_timestep(p, v, d, t)
        # Aggregate to region :OthNAmer by summing values of src over :Mex and :Can
        p.dst[t, :OthNAmer] = sum(v.src[t, [:Mex, :Can]])

        # Disaggregate :SAmer into :Bra and :OthSAmer by fraction of GDP
        p.dst[:Bra, t]      = v.src[t, :SAmer] * p.dgdp[t, :Bra]      / v.sgdp[t, :SAmer]
        p.dst[:OthSAmer, t] = v.src[t, :SAmer] * p.dgdp[t, :OthSAmer] / v.sgdp[t, :SAmer]
    end
end</code></pre><p>Notes:</p><ol><li><p>Specifying index values by symbol as we do currently is inadequate when these can  refer to different models. Probably need to support module specification, e.g.,  <code>dice2010.time</code>.</p></li><li><p>When combining components with different time dimensions, we should run the model on the union of all time dimension definitions. For example, if model 1 is defined on 10-yr timesteps (2010, 2020, ...) and model 2 is defined on 4-yr timesteps (2010, 2014, 2018, ...), the combined time dimension for the models would be (2010, 2014, 2018, 2020, 2022, ... ).</p><p>The main <code>run_timestep</code> would iterate over the combined time dimension, calling each component&#39;s <code>run_timestep</code> only for timesteps defined for that component.</p></li><li><p>If  <code>src</code> has 5-yr timesteps and <code>dst</code> has 10-yr timesteps, emissions in dst  time <code>tdst</code> would sum emissions from src time <code>tsrc</code> and <code>tsrc - 1</code>.  More generally, accumulating into <code>dst</code> in timestep <code>tdst</code> would sum values from <code>src</code> timesteps <code>tsrc</code> where  <code>tdst - 1 &lt; tsrc &lt;= tdst</code>. For dependencies on the  prior timestep, it would sum values where <code>dst[t-2] &lt; tsrc &lt;= dst[t-1]</code>.</p></li><li><p>Regional alignment may be combined with timestep alignment. In this case, time should be aligned first, since components are run on time boundaries. Then regional alignment can be handled based on time-aligned values.</p></li><li><p>In some cases, we will want to allocate values from a source model across multiple timesteps in the destination model. For example, if model <code>src</code> is defined on 10-yr timesteps (2010, 2020, 2030, ...) and model <code>dst</code> is defined on 5-yr timesteps, (2010, 2015, 2020, 2025, ...) we might allocate half of the 2010-2010  value from <code>src</code> in 2010-2020 to each of the <code>dst</code> periods 2010-2015 and 2015-2020. This allocation would be appropriate for flow parameters such as emissions. For stock  parameters, e.g., CO&lt;sub&gt;2&lt;/sub&gt; concentration, we would want to interpolate between <code>src</code> timestep values.</p><ul><li><p>This suggests a need for metadata on parameters indicating whether they are of the stock or flow variety.</p></li><li><p>The problem with this is that is requires knowing a future value to allocate or interpolate between a past value before the <code>dst</code> model&#39;s timestep <code>t</code>, and the subsequent value in occurring after <code>t</code>. This would require running the <code>dst</code> model one or more timesteps lagged.</p></li></ul></li></ol></article></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 20 May 2023 05:09">Saturday 20 May 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
